<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æˆ‘çš„æ—¶å…‰åœ°å›¾</title>
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.css" />
<style>
body, html, #map { margin: 0; height: 100%; background: #000b1a; }
.ui-panel { position: fixed; z-index: 1000; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
button { padding: 12px 24px; cursor: pointer; border-radius: 20px; border: none; font-weight: bold; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
.btn-up { background: #ff416c; }
.btn-reset { background: rgba(255,255,255,0.2); color: #ccc; }
/* ç…§ç‰‡å¤–æ¡† */
.photo-polaroid {
border: 4px solid white; border-bottom: 12px solid white;
width: 70px; height: 70px; object-fit: cover;
box-shadow: 0 5px 15px rgba(0,0,0,0.8);
animation: appear 0.6s ease-out;
}
@keyframes appear { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button class="btn-up" onclick="document.getElementById('fileIn').click()">ğŸ“· è®°å½•ç¬é—´</button>
<button class="btn-reset" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<script>
// --- é…ç½®åŒº ---
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';

// åˆå§‹åŒ– Supabase
const _db = supabase.createClient(SB_URL, SB_KEY);

// åˆå§‹åŒ–åœ°å›¾ï¼ˆæš—è‰²è°ƒï¼‰
var map = L.map('map', { zoomControl: false }).setView([20, 0], 3);
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

const colors = {"2024":"#ff4500","2025":"#00ff00","2026":"#00bfff","default":"#ffffff"};

// --- é†’ç›®è½¨è¿¹å‡½æ•° ---
async function drawLine(start, end, color) {
return new Promise(res => {
const path = L.polyline.antPath([start, start], {
color: color, pulseColor: '#fff', weight: 10, delay: 1000
}).addTo(map);

let count = 0, steps = 30;
const timer = setInterval(() => {
count++;
let lat = start[0] + (end[0]-start[0])*(count/steps);
let lng = start[1] + (end[1]-start[1])*(count/steps);
path.setLatLngs([start, [lat, lng]]);
if(count >= steps) { clearInterval(timer); res(); }
}, 30);
});
}

// --- åŠ è½½é€»è¾‘ ---
async function startShow() {
try {
const { data } = await _db.from('footprints').select('*').order('created_at', {ascending: true});
if(!data || data.length === 0) return;

map.flyTo([data[0].lat, data[0].lng], 6);
await new Promise(r => setTimeout(r, 3000));

let last = null;
for(let item of data) {
const year = new Date(item.created_at).getFullYear();
const col = colors[year] || colors.default;
const pos = [item.lat, item.lng];

if(last) await drawLine(last, pos, col);

// è´´ç…§ç‰‡
const icon = L.divIcon({
className: '',
html: item.img_url ? `<img src="${item.img_url}" class="photo-polaroid">` : `<div style="background:${col}; width:20px; height:20px; border-radius:50%"></div>`,
iconSize: [70, 70]
});
L.marker(pos, {icon: icon}).addTo(map);
map.panTo(pos);

await new Promise(r => setTimeout(r, 1000));
last = pos;
}
} catch(e) { console.error("åŠ è½½å‡ºé”™äº†ï¼Œæ£€æŸ¥KEYæ˜¯å¦æ­£ç¡®"); }
}
startShow();

// --- ä¸Šä¼ å¹¶å‹ç¼© ---
document.getElementById('fileIn').onchange = function(e) {
const file = e.target.files[0];
if(!file) return;

const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = function() {
const canvas = document.createElement('canvas');
canvas.width = 400; canvas.height = 400; // é€‚å½“å¢åŠ æ¸…æ™°åº¦
canvas.getContext('2d').drawImage(img, 0, 0, 400, 400);
const base64 = canvas.toDataURL('image/jpeg', 0.6);

EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude");
const lon = EXIF.getTag(this, "GPSLongitude");
if(lat && lon) {
const latNum = (lat[0] + lat[1]/60 + lat[2]/3600);
const lonNum = (lon[0] + lon[1]/60 + lon[2]/3600);
await _db.from('footprints').insert([{ lat: latNum, lng: lonNum, img_url: base64, user_id: 'me' }]);
location.reload();
} else {
alert("è¿™å¼ ç…§ç‰‡æ²¡æœ‰ä½ç½®ä¿¡æ¯å“¦");
}
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
};

async function clearAll() {
if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', 'me');
location.reload();
}
}
</script>
</body>
</html>
