
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·æ…¢æ—¶å…‰ç¨³å¥ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<style>
/* æ ¸å¿ƒï¼šç¡®ä¿é«˜åº¦ 100% ä¸”èƒŒæ™¯è‰²ä¸ºæ·±è‰²ï¼Œé˜²æ­¢äº®ççœ¼ */
body, html, #map { margin:0; height:100%; width:100%; background: #000b1a; }
.ui-panel { position:fixed; z-index:9999; bottom:30px; left:50%; transform:translateX(-50%); width: 95%; text-align:center; display: flex; justify-content: center; gap: 15px; }
button { padding: 14px 25px; color: white; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.4); font-size: 14px; transition: all 0.5s; background: linear-gradient(135deg, #667eea, #764ba2); }
.btn-clear { background: rgba(255,255,255,0.1) !important; color: #ccc !important; }

/* ç…§ç‰‡æ ·å¼ */
.photo-marker-icon { border: 3px solid white; border-radius: 50%; width:70px; height:70px; object-fit:cover; box-shadow: 0 0 20px rgba(255,255,255,0.8); }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">âœ¨ æ·»åŠ è¶³è¿¹</button>
<button class="btn-clear" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®ç‰ˆå›¾</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
// --- è¯·å¡«å…¥ä½ çš„çœŸå®ä¿¡æ¯ ---
const SUPABASE_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

[span_2](start_span)// åˆå§‹åŒ–åœ°å›¾[span_2](end_span)
var map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
[span_3](start_span)// ä½¿ç”¨æœ€ç¨³çš„åº•å›¾å›¾å±‚[span_3](end_span)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

[span_4](start_span)// æ ¸å¿ƒåŠ©æ‰‹ï¼šæ‰è½ç…§ç‰‡[span_4](end_span)
function dropPhoto(point, imgUrl) {
if (imgUrl) {
const icon = L.divIcon({
html: `<img src="${imgUrl}" class="photo-marker-icon">`,
iconSize: [70, 70],
className: ''
});
L.marker(point, {icon: icon}).addTo(map);
} else {
L.circleMarker(point, { radius: 8, color: "#00f2fe" }).addTo(map);
}
}

[span_5](start_span)// åŠ è½½å†å²[span_5](end_span)
async function loadHistory() {
const { data } = await _db.from('footprints').select('*').order('created_at', { ascending: true });
if (data) {
data.forEach(p => {
dropPhoto([p.lat, p.lng], p.img_url);
});
}
}
loadHistory();

[span_6](start_span)// ä¿®å¤ä¸Šä¼ ï¼šçœŸæ­£è¯»å–æ–‡ä»¶[span_6](end_span)
document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
files.forEach(file => {
const reader = new FileReader();
reader.onload = function(ev) {
const base64Data = ev.target.result; // è¿™é‡Œæ‹¿åˆ°äº†ç…§ç‰‡
EXIF.getData(file, async function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

[span_7](start_span)// æ’å…¥æ•°æ®åº“[span_7](end_span)
await _db.from('footprints').insert([{
lat: latNum, lng: lonNum, img_url: base64Data, user_id: "me"
}]);
location.reload();
}
});
};
reader.readAsDataURL(file);
});
};

async function clearAll() {
if(confirm("ç¡®å®šè¦é‡å¯å—ï¼Ÿ")) {
await _db.from('footprints').delete().neq('id', 0);
location.reload();
}
}
</script>
</body>
</html>
