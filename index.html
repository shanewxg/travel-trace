<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·æ—¶å…‰åŠ é€Ÿç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<style>
body, html, #map { margin:0; height:100%; background: #000b1a; }
.ui-panel { position:fixed; z-index:9999; bottom:30px; left:50%; transform:translateX(-50%); width: 95%; text-align:center; display: flex; justify-content: center; gap: 15px; }
button { padding: 14px 25px; color: white; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.4); font-size: 14px; }
.btn-upload { background: linear-gradient(135deg, #667eea, #764ba2); }
.btn-clear { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); color: #ccc; }

/* ç…§ç‰‡æ ‡è®°åŠ¨ç”»ï¼šç¼©çŸ­äº†ä¸€ç‚¹æ—¶é—´ï¼Œè®©å¼¹å‡ºæ›´å¹²è„† */
.photo-marker-icon {
border: 3px solid white; border-radius: 50%; width:70px; height:70px;
object-fit:cover; box-shadow: 0 0 20px rgba(255,255,255,0.8);
animation: cinematicIn 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
@keyframes cinematicIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button class="btn-upload" onclick="document.getElementById('fileIn').click()">âœ¨ æ·»åŠ è¶³è¿¹</button>
<button class="btn-clear" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®ç‰ˆå›¾</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
const SUPABASE_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const yearColors = {
"2018": "#FFB6C1", "2019": "#1E90FF", "2020": "#800080", "2021": "#90EE90", "2022": "#008000",
"2023": "#556B2F", "2024": "#8B4513", "2025": "#FFFF00", "2026": "#FF8C00", "2027": "#FF0000",
"default": "#FFFFFF"
};

var map = L.map('map', { zoomControl: false, scrollWheelZoom: true }).setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- æ ¸å¿ƒï¼šåŠ é€Ÿç”Ÿé•¿çš„çº¿æ¡å‡½æ•° ---
async function animateLineToNext(start, end, color) {
return new Promise((resolve) => {
const steps = 60; // å‡å°‘æ­¥æ•°ï¼Œæé«˜å•æ­¥è·¨åº¦
let currentStep = 0;
const growingLine = L.polyline.antPath([start, start], {
delay: 2000, // å†…éƒ¨æµå…‰é€Ÿåº¦ä¹ŸåŠ å¿«
color: color,
pulseColor: "#ffffff",
weight: 5
}).addTo(map);

const interval = setInterval(() => {
currentStep++;
const lat = start[0] + (end[0] - start[0]) * (currentStep / steps);
const lng = start[1] + (end[1] - start[1]) * (currentStep / steps);
growingLine.setLatLngs([start, [lat, lng]]);

if (currentStep >= steps) {
clearInterval(interval);
resolve();
}
}, 30); // é—´éš”ä» 50ms ç¼©çŸ­åˆ° 30msï¼Œæ€»è€—æ—¶çº¦ 1.8 ç§’ä¸€æ®µ
});
}

async function loadHistory() {
try {
const { data, error } = await _db.from('footprints').select('*').order('created_at', { ascending: true });
if (error) throw error;
if (!data || data.length === 0) return;

// 1. ä¿¯å†²å¼€åœºï¼šåŠ é€Ÿåˆ° 4 ç§’
map.flyTo([data[0].lat, data[0].lng], 8, { duration: 4 });
await new Promise(res => setTimeout(res, 4500));

let previousPoint = null;

for (let i = 0; i < data.length; i++) {
const p = data[i];
const year = new Date(p.created_at).getFullYear().toString();
const color = yearColors[year] || yearColors["default"];
const currentPoint = [p.lat, p.lng];

// å¦‚æœæœ‰ä¸Šä¸€ä¸ªç‚¹ï¼Œå…ˆè·‘è½¨è¿¹
if (previousPoint) {
await animateLineToNext(previousPoint, currentPoint, color);
}

// --- è½¨è¿¹åˆ°è¾¾ï¼æ˜¾ç¤ºç…§ç‰‡å’Œåœ†ç‚¹ ---
map.panTo(currentPoint, { animate: true, duration: 1 });

// ç»˜åˆ¶åŸºç¡€ç‚¹
L.circleMarker(currentPoint, { radius: 6, color: color, fillColor: color, fillOpacity: 0.8 }).addTo(map);

// ã€é‡ç‚¹ã€‘è¿™é‡Œæ˜¯ç…§ç‰‡æ˜¾ç¤ºé€»è¾‘ï¼šç”±äºæ•°æ®åº“è¿˜æ²¡å­˜å›¾ç‰‡ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªå¸¦åŠ¨ç”»çš„æ ‡è®°
// å¦‚æœåç»­ä½ ç”¨äº†äº‘å­˜å‚¨ï¼Œè¿™é‡Œå°±æ”¾çœŸæ­£çš„å›¾ç‰‡åœ°å€
const photoIcon = L.divIcon({
html: `<div class="photo-marker-icon" style="background:${color}; display:flex; align-items:center; justify-content:center; color:white; font-size:10px;">${year}</div>`,
className: '',
iconSize: [40, 40]
});
L.marker(currentPoint, { icon: photoIcon }).addTo(map);

// ç¼©çŸ­åœç•™æ—¶é—´ï¼šä» 4ç§’ å‡åˆ° 1.5ç§’
await new Promise(res => setTimeout(res, 1500));

previousPoint = currentPoint;
}
} catch (e) { console.error("åŠ è½½å‡ºé”™:", e); }
}
loadHistory();

// ä¸Šä¼ é€»è¾‘
document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
files.forEach(file => {
EXIF.getData(file, async function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);
const { error } = await _db.from('footprints').insert([{ lat: latNum, lng: lonNum, img_url: "", user_id: "me" }]);
if (!error) {
alert("è¶³è¿¹å½•å…¥æˆåŠŸï¼");
location.reload();
}
}
});
});
};

async function clearAll() {
if(confirm("ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', 'me');
setTimeout(() => { window.location.reload(); }, 500);
}
}
</script>
</body>
</html>
