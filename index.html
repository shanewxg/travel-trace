<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>足迹地图-调试版</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body, html { margin: 0; padding: 0; height: 100%; background: #000; }
#map { height: 100%; width: 100%; } /* 确保地图容器有尺寸 */
.ui-panel { position: fixed; z-index: 1000; bottom: 20px; left: 50%; transform: translateX(-50%); }
button { padding: 10px 20px; background: #ff416c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
.photo-frame { border: 3px solid white; box-shadow: 0 0 10px rgba(255,255,255,0.5); width: 60px; height: 60px; object-fit: cover; }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">添加照片</button>
<button style="background:#444" onclick="clearAll()">重置</button>
</div>
<input type="file" id="fileIn" accept="image/*" style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<script>
// --- 1. 配置区 ---
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';

let _db;
try {
_db = supabase.createClient(SB_URL, SB_KEY);
} catch(e) {
alert("Supabase 初始化失败，请检查 URL 和 Key");
}

// --- 2. 初始化地图（这是最关键的一步，必须先亮起来） ---
var map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- 3. 醒目轨迹函数 ---
async function drawTrack(start, end) {
return new Promise(res => {
const line = L.polyline.antPath([start, end], {
color: '#00f2fe', pulseColor: '#fff', weight: 10, delay: 1000
}).addTo(map);
setTimeout(res, 1500); // 简单处理：画线等待 1.5 秒
});
}

// --- 4. 自动加载 ---
async function init() {
if(!_db) return;
const { data, error } = await _db.from('footprints').select('*').order('created_at', {ascending: true});

if(error) {
console.error("数据库读取错误:", error);
return;
}
if(!data || data.length === 0) return;

let last = null;
for(let item of data) {
const pos = [item.lat, item.lng];
if(last) await drawTrack(last, pos);

const icon = L.divIcon({
html: item.img_url ? `<img src="${item.img_url}" class="photo-frame">` : `<div style="background:#00f2fe;width:10px;height:10px;border-radius:50%"></div>`,
className: '', iconSize: [60, 60]
});
L.marker(pos, {icon: icon}).addTo(map);
map.panTo(pos);
last = pos;
await new Promise(r => setTimeout(r, 1000));
}
}

// 延迟 1 秒加载数据，确保地图背景已亮
setTimeout(init, 1000);

// --- 5. 上传处理 ---
document.getElementById('fileIn').onchange = function(e) {
const file = e.target.files[0];
if(!file) return;

const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = function() {
const canvas = document.createElement('canvas');
canvas.width = 200; canvas.height = 200;
canvas.getContext('2d').drawImage(img, 0, 0, 200, 200);
const miniImg = canvas.toDataURL('image/jpeg', 0.5);

EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude");
const lon = EXIF.getTag(this, "GPSLongitude");
if(lat && lon) {
const latNum = (lat[0] + lat[1]/60 + lat[2]/3600);
const lonNum = (lon[0] + lon[1]/60 + lon[2]/3600);
await _db.from('footprints').insert([{ lat: latNum, lng: lonNum, img_url: miniImg, user_id: 'me' }]);
location.reload();
} else { alert("照片里没有 GPS 坐标！"); }
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
};

async function clearAll() {
if(confirm("确定清空数据？")) {
await _db.from('footprints').delete().eq('user_id', 'me');
location.reload();
}
}
</script>
</body>
</html>
