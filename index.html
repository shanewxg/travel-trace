<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>足迹平台预览 - 流量发光版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<style>
body { margin:0; padding:0; background: #000b1a; color: white; font-family: sans-serif; }
#map { height:100vh; width:100%; background: #000b1a; }

/* 这里的按钮控制音乐和模拟身份 */
.ui-panel { position:fixed; z-index:9999; bottom:30px; left:50%; transform:translateX(-50%); text-align:center; width: 90%; }
button {
padding: 15px 30px; background: linear-gradient(135deg, #00f2fe, #4facfe);
color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold;
cursor: pointer; box-shadow: 0 0 20px rgba(79, 172, 254, 0.6); margin: 5px;
}

/* 核心：自定义聚簇发光样式（照片多的时候会变大发光） */
.my-cluster {
width: 40px; height: 40px; border-radius: 50%;
background: rgba(0, 242, 254, 0.6);
box-shadow: 0 0 20px #00f2fe, 0 0 40px #4facfe;
display: flex; align-items: center; justify-content: center;
color: white; font-weight: bold; font-size: 14px;
animation: pulse 2s infinite;
}
@keyframes pulse {
0% { transform: scale(1); box-shadow: 0 0 20px #00f2fe; }
50% { transform: scale(1.2); box-shadow: 0 0 50px #4facfe; }
100% { transform: scale(1); box-shadow: 0 0 20px #00f2fe; }
}

.photo-marker {
border: 2px solid #fff; border-radius: 8px;
box-shadow: 0 0 15px rgba(255,255,255,0.5);
width:60px; height:60px; object-fit:cover;
}
</style>
</head>
<body>

<div id="map"></div>
<audio id="bgMusic" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg"></audio>

<div class="ui-panel">
<div style="margin-bottom: 15px; font-size: 12px; opacity: 0.8;">
当前视角：<span id="viewLabel">公开流量模式</span>
</div>
<button onclick="handleUpload()">上传我的足迹</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
// 使用暗色系底图，更能衬托“发光”效果
var map = L.map('map', { zoomControl: false }).setView([30, 105], 4);
L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
subdomains: ["1", "2", "3", "4"]
}).addTo(map);

// 初始化聚簇图层（照片多的时候闪闪发光的核心）
var markers = L.markerClusterGroup({
iconCreateFunction: function(cluster) {
return L.divIcon({
html: '<div class="my-cluster"><span>' + cluster.getChildCount() + '</span></div>',
className: 'cluster-icon',
iconSize: [40, 40]
});
},
showCoverageOnHover: false
});
map.addLayer(markers);

function handleUpload() {
document.getElementById('bgMusic').play().catch(()=>{});
document.getElementById('fileIn').click();
}

document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
var photoData = [];
var loaded = 0;

files.forEach(function(file) {
EXIF.getData(file, function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);
photoData.push({ lat: latNum, lng: lonNum, url: URL.createObjectURL(file) });
}
loaded++;
if (loaded === files.length) processPhotos(photoData);
});
});
};

function processPhotos(data) {
data.forEach(p => {
var icon = L.divIcon({
html: `<img src="${p.url}" class="photo-marker">`,
className: '', iconSize: [60, 60], iconAnchor: [30, 30]
});
var marker = L.marker([p.lat, p.lng], { icon: icon });
markers.addLayer(marker);
});

if(data.length > 0) {
map.flyToBounds(data.map(p => [p.lat, p.lng]), { padding: [50, 50], duration: 2 });
}
}
</script>
</body>
</html>
