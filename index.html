<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æˆ‘çš„æ—¶å…‰åœ°å›¾-å›å½’åˆå¿ƒç‰ˆ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* ç®€å•ç²—æš´çš„å¸ƒå±€ï¼Œç¡®ä¿ä¸ä¼šé»‘å± */
body, html, #map { margin: 0; padding: 0; height: 100%; width: 100%; background: #000b1a; }
.ui-panel { position: fixed; z-index: 1000; bottom: 30px; left: 50%; transform: translateX(-50%); }
button { padding: 15px 30px; cursor: pointer; border-radius: 50px; border: none; background: #ff416c; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
.photo-frame { border: 3px solid white; width: 60px; height: 60px; object-fit: cover; }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· ä¸Šä¼ ä¸€å¼ ç…§ç‰‡</button>
</div>
<input type="file" id="fileIn" accept="image/*" style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

<script>
// ======= åªéœ€è¦å¡«è¿™ä¸¤ä¸ªï¼Œç¡®ä¿åˆ«å¤åˆ¶é”™äº† =======
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
// ==========================================

const _db = supabase.createClient(SB_URL, SB_KEY);

// åˆå§‹åŒ–åœ°å›¾
var map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

// å›æ˜¾æ•°æ®
async function load() {
const { data } = await _db.from('footprints').select('*');
if (data) {
data.forEach(item => {
const icon = L.divIcon({
html: `<img src="${item.img_url}" class="photo-frame">`,
iconSize: [60, 60]
});
L.marker([item.lat, item.lng], {icon: icon}).addTo(map);
});
}
}
load();

// æœ€åŸå§‹çš„å•å¼ ä¸Šä¼ é€»è¾‘
document.getElementById('fileIn').onchange = function(e) {
const file = e.target.files[0];
const reader = new FileReader();
reader.onload = function(ev) {
const base64Img = ev.target.result;
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude");
const lon = EXIF.getTag(this, "GPSLongitude");
if (lat && lon) {
const latN = lat[0] + lat[1]/60 + lat[2]/3600;
const lonN = lon[0] + lon[1]/60 + lon[2]/3600;

// ç›´æ¥å­˜ï¼Œä¸å‹ç¼©ï¼Œå›åˆ°æœ€ç®€å•çš„æ—¶å€™
await _db.from('footprints').insert([
{ lat: latN, lng: lonN, img_url: base64Img, user_id: 'me' }
]);
location.reload();
} else {
alert("è¿™å¼ ç…§ç‰‡æ²¡æœ‰GPSä¿¡æ¯ï¼Œæ¢ä¸€å¼ è¯•è¯•ï¼Ÿ");
}
});
};
reader.readAsDataURL(file);
};
</script>
</body>
</html>
