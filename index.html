<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æˆ‘çš„æ—¶å…‰è¶³è¿¹</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body, html, #map { margin: 0; height: 100%; background: #000b1a; }
.ui-panel { position: fixed; z-index: 1000; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; }
button { padding: 15px 30px; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.6); font-size: 16px; }
.btn-up { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
.btn-reset { background: rgba(255,255,255,0.15); color: #fff; backdrop-filter: blur(5px); }

/* ç…§ç‰‡æ‹ç«‹å¾—æ•ˆæœ */
.photo-polaroid {
border: 4px solid #fff; border-bottom: 15px solid #fff;
width: 80px; height: 80px; object-fit: cover;
box-shadow: 0 0 15px rgba(255,255,255,0.5);
animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes pop { from { transform: scale(0) rotate(-10deg); } to { transform: scale(1) rotate(0deg); } }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button class="btn-up" onclick="document.getElementById('fileIn').click()">ğŸ“· ä¸Šä¼ ç…§ç‰‡</button>
<button class="btn-reset" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<script>
// 1. é…ç½®åŒºï¼ˆåŠ¡å¿…æ£€æŸ¥ URL å’Œ Key æ˜¯å¦æœ‰ç©ºæ ¼ï¼‰
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SB_URL, SB_KEY);

// 2. åˆå§‹åŒ–åœ°å›¾
var map = L.map('map', { zoomControl: false }).setView([20, 0], 3);
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

// 3. ç»˜åˆ¶é†’ç›®è½¨è¿¹ (10px)
async function drawStep(start, end, color) {
return new Promise(res => {
const antLine = L.polyline.antPath([start, start], {
color: color, pulseColor: '#ffffff', weight: 10, delay: 1500
}).addTo(map);

let i = 0; const steps = 40;
const timer = setInterval(() => {
i++;
let lat = start[0] + (end[0]-start[0])*(i/steps);
let lng = start[1] + (end[1]-start[1])*(i/steps);
antLine.setLatLngs([start, [lat, lng]]);
if(i >= steps) { clearInterval(timer); res(); }
}, 25);
});
}

// 4. æ—¶å…‰å›æº¯ä¸»é€»è¾‘
async function initPlay() {
try {
const { data, error } = await _db.from('footprints').select('*').order('created_at', {ascending: true});
if(error) throw error;
if(!data || data.length === 0) return;

// ä¿¯å†²åˆ°ç¬¬ä¸€ä¸ªç‚¹
map.flyTo([data[0].lat, data[0].lng], 7, {duration: 3});
await new Promise(r => setTimeout(r, 3500));

let lastPos = null;
for(let item of data) {
const pos = [item.lat, item.lng];
if(lastPos) await drawStep(lastPos, pos, '#00f2fe');

// è½¨è¿¹åˆ°è¾¾ï¼Œè´´ä¸Šç…§ç‰‡
const icon = L.divIcon({
className: '',
html: item.img_url ? `<img src="${item.img_url}" class="photo-polaroid">` : `<div style="background:#00f2fe;width:15px;height:15px;border-radius:50%"></div>`,
iconSize: [80, 100]
});
L.marker(pos, {icon: icon}).addTo(map);
map.panTo(pos);

await new Promise(r => setTimeout(r, 1000));
lastPos = pos;
}
} catch(e) {
console.error("åŠ è½½å¤±è´¥:", e.message);
}
}

// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå†å¯åŠ¨
window.onload = initPlay;

// 5. ä¸Šä¼ å¤„ç†ï¼ˆåŒ…å« Base64 è½¬æ¢ï¼‰
document.getElementById('fileIn').onchange = function(e) {
const file = e.target.files[0];
if(!file) return;

const reader = new FileReader();
reader.onload = function(ev) {
const base64 = ev.target.result; // è·å–ç…§ç‰‡å†…å®¹
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude");
const lon = EXIF.getTag(this, "GPSLongitude");
if(lat && lon) {
const latNum = (lat[0] + lat[1]/60 + lat[2]/3600);
const lonNum = (lon[0] + lon[1]/60 + lon[2]/3600);

await _db.from('footprints').insert([{
lat: latNum, lng: lonNum, img_url: base64, user_id: 'me'
}]);
location.reload();
} else {
alert("è¿™å¼ ç…§ç‰‡æ²¡æœ‰GPSä½ç½®ä¿¡æ¯");
}
});
};
reader.readAsDataURL(file);
};

async function clearAll() {
if(confirm("ç¡®å®šè¦é‡ç½®å—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', 'me');
location.reload();
}
}
</script>
</body>
</html>
