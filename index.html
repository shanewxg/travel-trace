<script>
const SUPABASE_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const yearColors = {
"2018": "#FFB6C1", "2019": "#1E90FF", "2020": "#800080", "2021": "#90EE90", "2022": "#008000",
"2023": "#556B2F", "2024": "#8B4513", "2025": "#FFFF00", "2026": "#FF8C00", "2027": "#FF0000",
"default": "#FFFFFF"
};

let lastGlobalPoint = null;

var map = L.map('map', { zoomControl: false, scrollWheelZoom: true }).setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- 核心：极慢速生长函数（比之前慢一倍以上） ---
async function animateLine(start, end, color) {
return new Promise((resolve) => {
const steps = 200; // 极其细腻的拆分，200个小节
let currentStep = 0;
const tempCoords = [start];

const growingLine = L.polyline.antPath([start, start], {
delay: 8000, // 内部流光也调慢
color: color,
pulseColor: "#ffffff",
weight: 5
}).addTo(map);

const interval = setInterval(() => {
currentStep++;
const lat = start[0] + (end[0] - start[0]) * (currentStep / steps);
const lng = start[1] + (end[1] - start[1]) * (currentStep / steps);

tempCoords.push([lat, lng]);
growingLine.setLatLngs(tempCoords);

if (currentStep >= steps) {
clearInterval(interval);
resolve();
}
}, 50); // 每50毫秒走一小步，整段轨迹生长约需 10 秒钟
});
}

async function loadHistory() {
const { data } = await _db.from('footprints').select('*').order('created_at', { ascending: true });

if (data && data.length > 0) {
// 1. 极慢速俯冲开场 (8秒)
map.flyTo([data[0].lat, data[0].lng], 7, { duration: 8, easeLinearity: 0.1 });
await new Promise(res => setTimeout(res, 9000));

for (let i = 0; i < data.length; i++) {
const p = data[i];
const year = new Date(p.created_at).getFullYear().toString();
const color = yearColors[year] || yearColors["default"];
const currentPoint = [p.lat, p.lng];

// 2. 摄像机缓缓移向目标
map.panTo(currentPoint, { animate: true, duration: 3 });
await new Promise(res => setTimeout(res, 1000));

// 3. 落下发光点
L.circleMarker(currentPoint, { radius: 8, color: color, fillColor: color, fillOpacity: 0.8 }).addTo(map);

// 4. 开始极其缓慢的生长
if (lastGlobalPoint) {
await animateLine(lastGlobalPoint, currentPoint, color);
}

lastGlobalPoint = currentPoint;
// 每段结束后的“回味”时间
await new Promise(res => setTimeout(res, 4000));
}
}
}
loadHistory();

// 上传逻辑（同步减速）
document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
files.forEach(file => {
EXIF.getData(file, async function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);
const currentPoint = [latNum, lonNum];

const { error } = await _db.from('footprints').insert([{ lat: latNum, lng: lonNum, img_url: "", user_id: "me" }]);
if (!error) {
map.flyTo(currentPoint, 10, { duration: 5 });
setTimeout(async () => {
var tempUrl = URL.createObjectURL(file);
var icon = L.divIcon({ html: `<img src="${tempUrl}" class="photo-marker-icon">`, className: '', iconSize: [70, 70] });
L.marker(currentPoint, { icon: icon }).addTo(map);

if (lastGlobalPoint) {
await animateLine(lastGlobalPoint, currentPoint, "#ffffff");
}
lastGlobalPoint = currentPoint;
}, 5000);
}
}
});
});
};

async function clearAll() {
if(confirm("确定要重启人生版图吗？")) {
await _db.from('footprints').delete().neq('id', 0);
location.reload();
}
}
</script>
