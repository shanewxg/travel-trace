<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å›å½’æœ€åˆçš„åœ°å›¾</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* 1. æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»ç»™ body å’Œ map 100% é«˜åº¦ï¼Œå¦åˆ™åœ°å›¾é«˜åº¦ä¸º0ï¼Œå°±ä¼šé»‘å± */
body, html, #map { margin: 0; padding: 0; height: 100%; width: 100%; background: #000b1a; }
.ui-panel { position: fixed; z-index: 1000; bottom: 30px; left: 50%; transform: translateX(-50%); }
button { padding: 15px 30px; cursor: pointer; border-radius: 50px; border: none; background: #ff416c; color: white; font-weight: bold; }
.photo-frame { border: 3px solid white; width: 60px; height: 60px; object-fit: cover; }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· ä¸Šä¼ ç…§ç‰‡</button>
</div>
<input type="file" id="fileIn" accept="image/*" style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

<script>
// ======= 3. åªéœ€è¦å¡«è¿™ä¸¤ä¸ªï¼Œç¡®ä¿å¼•å·ä¿ç•™ =======
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
// ==========================================

// åˆå§‹åŒ–æ•°æ®åº“
const _db = supabase.createClient(SB_URL, SB_KEY);

// 4. åˆå§‹åŒ–åœ°å›¾ï¼ˆå¦‚æœè¿™é‡ŒæŠ¥é”™ï¼Œé¡µé¢å°±ä¼šå…¨é»‘ï¼‰
var map = L.map('map', { zoomControl: false }).setView([20, 0], 2);

// ä½¿ç”¨æš—è‰²æ»¤é•œåœ°å›¾
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

// åŠ è½½å·²æœ‰ç…§ç‰‡
async function load() {
const { data } = await _db.from('footprints').select('*');
if (data) {
data.forEach(item => {
const icon = L.divIcon({
html: `<img src="${item.img_url}" class="photo-frame">`,
iconSize: [60, 60]
});
L.marker([item.lat, item.lng], {icon: icon}).addTo(map);
});
}
}
load();

// åŸå§‹ä¸Šä¼ é€»è¾‘ï¼ˆä¸€å¼ ä¸€å¼ æ¥ï¼Œæœ€ç¨³ï¼‰
document.getElementById('fileIn').onchange = function(e) {
const file = e.target.files[0];
if(!file) return;

const reader = new FileReader();
reader.onload = function(ev) {
const base64Img = ev.target.result;
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude");
const lon = EXIF.getTag(this, "GPSLongitude");

if (lat && lon) {
const latN = lat[0] + lat[1]/60 + lat[2]/3600;
const lonN = lon[0] + lon[1]/60 + lon[2]/3600;

// ç›´æ¥å­˜ï¼Œä¸å‹ç¼©ï¼Œæ‰¾å›ä¹‹å‰çš„æ„Ÿè§‰
await _db.from('footprints').insert([
{ lat: latN, lng: lonN, img_url: base64Img, user_id: 'me' }
]);
location.reload();
} else {
alert("æ£€æµ‹ä¸åˆ°ç…§ç‰‡çš„åœ°ç†ä½ç½®ï¼Œè¯·ç¡®ä¿æ˜¯åŸå›¾ä¸Šä¼ ã€‚");
}
});
};
reader.readAsDataURL(file);
};
</script>
</body>
</html>
