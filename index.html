<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æˆ‘çš„æ—¶å…‰åœ°å›¾</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* å¼ºåˆ¶æ’‘å¼€å®¹å™¨ï¼Œè§£å†³é»‘å± */
body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
#map { height: 100vh; width: 100vw; background: #000b1a; }

.ui-panel { position: fixed; z-index: 1000; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
button { padding: 12px 24px; cursor: pointer; border-radius: 30px; border: none; font-weight: bold; color: white; background: #ff416c; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
.photo-frame { border: 4px solid white; border-bottom: 12px solid white; width: 70px; height: 70px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· æ‰¹é‡ä¸Šä¼ </button>
<button style="background:rgba(255,255,255,0.2)" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<script>
// --- åªè¦æ”¹è¿™é‡Œ ---
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
// ----------------

const _db = supabase.createClient(SB_URL, SB_KEY);

// åˆå§‹åŒ–åœ°å›¾
var map = L.map('map', { zoomControl: false }).setView([20, 0], 3);
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

// åŠ è½½æ•°æ®é€»è¾‘
async function loadData() {
const { data } = await _db.from('footprints').select('*').order('created_at', {ascending: true});
if(!data || data.length === 0) return;

map.flyTo([data[0].lat, data[0].lng], 6);
let last = null;

for(let item of data) {
const pos = [item.lat, item.lng];
if(last) {
L.polyline.antPath([last, pos], { color: '#00f2fe', weight: 8 }).addTo(map);
}
const icon = L.divIcon({
html: item.img_url ? `<img src="${item.img_url}" class="photo-frame">` : ``,
iconSize: [70, 70]
});
L.marker(pos, {icon: icon}).addTo(map);
last = pos;
}
}

// å¤„ç†ä¸Šä¼ 
document.getElementById('fileIn').onchange = async function(e) {
const files = Array.from(e.target.files);
for (const file of files) {
const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = function() {
const canvas = document.createElement('canvas');
canvas.width = 300; canvas.height = 300;
canvas.getContext('2d').drawImage(img, 0, 0, 300, 300);
const mini = canvas.toDataURL('image/jpeg', 0.6);
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
if(lat && lon) {
let latN = lat[0] + lat[1]/60 + lat[2]/3600;
let lonN = lon[0] + lon[1]/60 + lon[2]/3600;
await _db.from('footprints').insert([{ lat: latN, lng: lonN, img_url: mini, user_id: 'me' }]);
}
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
}
setTimeout(() => location.reload(), 2000);
};

function clearAll() {
if(confirm("ç¡®å®šé‡ç½®ï¼Ÿ")) {
_db.from('footprints').delete().eq('user_id', 'me').then(() => location.reload());
}
}

loadData();
</script>
</body>
</html>
