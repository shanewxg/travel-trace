<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æ—¶å…‰åœ°å›¾-å›å½’ç¨³å¥ç‰ˆ</title>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<style>
/* å¼ºåˆ¶å…¨å±æ’‘å¼€ï¼Œè§£å†³é»‘å± */
body, html, #map { margin: 0; padding: 0; height: 100vh; width: 100vw; background: #000b1a; }
.ui-panel { position: fixed; z-index: 9999; bottom: 30px; left: 50%; transform: translateX(-50%); }
button { padding: 15px 30px; background: #ff416c; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
/* ç…§ç‰‡é¢„è§ˆæ ·å¼ */
.photo-marker { border: 2px solid white; border-radius: 5px; width: 50px; height: 50px; object-fit: cover; }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· ä¸Šä¼ ä¸€å¼ ç…§ç‰‡</button>
</div>
<input type="file" id="fileIn" accept="image/*" style="display:none">

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

<script>
// ======= ğŸš© å¡«å…¥ä½ çš„ä¿¡æ¯ =======
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
// =============================

const _db = supabase.createClient(SB_URL, SB_KEY);

// 1. åˆå§‹åŒ–åœ°å›¾ï¼ˆåœ°åŸºï¼Œåªè¦è¿™é‡Œè·‘é€šï¼Œå°±ä¸ä¼šé»‘å±ï¼‰
var map = L.map('map', { zoomControl: false }).setView([30, 110], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 2. æ˜¾ç¤ºç…§ç‰‡é€»è¾‘
async function loadHistory() {
const { data } = await _db.from('footprints').select('*');
if (data) {
data.forEach(p => {
if (p.img_url) {
const icon = L.divIcon({
html: `<img src="${p.img_url}" class="photo-marker">`,
iconSize: [50, 50], className: ''
});
L.marker([p.lat, p.lng], {icon: icon}).addTo(map);
}
});
}
}
loadHistory();

// 3. ä¸Šä¼ é€»è¾‘ï¼šè¿™æ˜¯ä¿®å¤äº†â€œä¼ ä¸ä¸Šå»â€é—®é¢˜çš„å…³é”®
document.getElementById('fileIn').onchange = function(e) {
const file = e.target.files[0];
if (!file) return;

const reader = new FileReader();
// åªæœ‰åŠ äº† readerï¼Œç…§ç‰‡çš„åƒç´ æ•°æ®æ‰èƒ½å˜æˆå¯ä»¥å­˜è¿›æ•°æ®åº“çš„ä»£ç 
reader.onload = function(ev) {
const imageData = ev.target.result;

EXIF.getData(file, async function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");

if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

// æ ¸å¿ƒï¼šæŠŠè¯»å–åˆ°çš„ imageData å­˜å…¥ img_url
await _db.from('footprints').insert([{
lat: latNum, lng: lonNum, img_url: imageData, user_id: "me"
}]);

alert("ä¸Šä¼ æˆåŠŸï¼");
location.reload();
} else {
alert("æ£€æµ‹ä¸åˆ°ç…§ç‰‡çš„GPSä¿¡æ¯ï¼Œè¯·ç¡®ä¿ä¸Šä¼ çš„æ˜¯æ‰‹æœºæ‹æ‘„çš„åŸå›¾ã€‚");
}
});
};
reader.readAsDataURL(file);
};
</script>
</body>
</html>
