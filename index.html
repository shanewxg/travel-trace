<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·ç»ˆæä¿®å¤ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://cdn.staticfile.net/leaflet/1.9.4/leaflet.css" />
<style>
body, html, #map { margin:0; height:100%; width:100%; background: #000b1a; }
.ui-panel { position:fixed; z-index:9999; bottom:20px; left:50%; transform:translateX(-50%); display: flex; gap: 8px; width: 95%; justify-content: center; }
button { padding: 10px 14px; color: white; border: none; border-radius: 20px; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); font-size: 12px; white-space: nowrap; cursor: pointer; }
.photo-marker-icon { border: 2px solid white; border-radius: 8px; width:90px; height:90px; object-fit:cover; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.top-ui { position: fixed; top: 15px; left: 15px; z-index: 10000; display: flex; gap: 10px; }
.status-tag { padding: 5px 12px; background: rgba(0,0,0,0.5); border-radius: 15px; color: white; font-size: 12px; backdrop-filter: blur(5px); }
</style>
</head>
<body>

<div class="top-ui">
<div class="status-tag" id="musicBtn">ğŸ¶ <span id="mTxt">æ’­æ”¾éŸ³ä¹</span></div>
<div class="status-tag" id="loadStatus">ğŸš€ å‡†å¤‡å¯åŠ¨...</div>
</div>
<audio id="bgm" loop></audio>

<div id="map"></div>

<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· å½©è™¹å…‰å½±</button>
<button onclick="openShare()">ğŸ”— åˆ†äº«è¶³è¿¹</button>
<button style="background:rgba(255,255,255,0.2)" onclick="clearAll()">ğŸ•¯ï¸ é‡å¯</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script src="https://cdn.staticfile.net/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdn.staticfile.net/supabase/2.39.7/supabase-js.js"></script>
<script src="https://cdn.staticfile.net/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>
<script src="https://cdn.staticfile.net/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const BGM_URL = 'ä½ çš„éŸ³ä¹.mp3';

let _db, map;
const myID = (() => {
let id = localStorage.getItem('my_footprint_id');
if (!id) {
id = 'user_' + Math.random().toString(36).substr(2, 9);
localStorage.setItem('my_footprint_id', id);
}
return id;
})();

function init() {
console.log("å¯åŠ¨åˆå§‹åŒ–...");
// å¼ºåˆ¶å…ˆæ¸²æŸ“åœ°å›¾ï¼Œå“ªæ€•æ•°æ®åº“è¿˜æ²¡è¿ä¸Š
map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([34, 108], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// å»¶è¿Ÿ 1 ç§’å†æ‰§è¡Œæ•°æ®åº“é€»è¾‘ï¼Œé˜²æ­¢å®‰å“/ç”µè„‘åŠ è½½é˜»å¡
setTimeout(async () => {
try {
_db = supabase.createClient(SB_URL, SB_KEY);
document.getElementById('bgm').src = BGM_URL;
await loadHistory();
} catch (e) {
console.error("æ•°æ®åº“è¿æ¥å¤±è´¥", e);
document.getElementById('loadStatus').innerText = "ç½‘ç»œå¼‚å¸¸";
}
}, 1000);
}

async function loadHistory() {
const status = document.getElementById('loadStatus');
status.innerText = "ğŸš€ åŒæ­¥è¶³è¿¹ä¸­...";

const { data, error } = await _db.from('footprints').select('*').eq('user_id', myID).order('created_at', { ascending: true });

if (error || !data || data.length === 0) {
status.innerText = "âœ¨ æš‚æ— è¶³è¿¹ï¼Œè¯·ç‚¹å‡»æ·»åŠ ";
setTimeout(() => status.style.display = 'none', 3000);
return;
}

status.innerText = "ğŸï¸ è½¨è¿¹é‡æ¼”ä¸­...";
let lastPoint = null;
for (let p of data) {
const currentPoint = [p.lat, p.lng];
map.flyTo(currentPoint, 11, { animate: true, duration: 1 });
await new Promise(r => setTimeout(r, 1100));

// ä¸‹è½ç…§ç‰‡
L.circleMarker(currentPoint, { radius: 5, color: "#00BFFF", fillColor: "#fff", fillOpacity: 1 }).addTo(map);
if (p.img_url) {
L.marker(currentPoint, {
icon: L.divIcon({
html: `<img src="${p.img_url}" class="photo-marker-icon">`,
iconSize: [90, 90], iconAnchor: [45, 90]
})
}).addTo(map);
}

if (lastPoint) {
L.polyline.antPath([lastPoint, currentPoint], { delay: 600, weight: 7, color: "#00BFFF" }).addTo(map);
}
lastPoint = currentPoint;
await new Promise(r => setTimeout(r, 600));
}
status.style.display = 'none';
}

// åˆ†äº«ã€ä¸Šä¼ ã€éŸ³ä¹ç­‰åŠŸèƒ½ä¿æŒä¸å˜ï¼Œä½†å¢åŠ  try-catch ä¿æŠ¤
document.getElementById('musicBtn').onclick = () => {
const bgm = document.getElementById('bgm');
if (bgm.paused) { bgm.play(); document.getElementById('mTxt').innerText = "æš‚åœ"; }
else { bgm.pause(); document.getElementById('mTxt').innerText = "æ’­æ”¾"; }
};

document.getElementById('fileIn').onchange = async function(e) {
const files = Array.from(e.target.files);
for (const file of files) {
const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = function() {
const canvas = document.createElement('canvas');
canvas.width = 400; canvas.height = 400;
canvas.getContext('2d').drawImage(img, 0, 0, 400, 400);
const miniData = canvas.toDataURL('image/jpeg', 0.6);
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
if (lat && lon) {
const latN = lat[0] + lat[1]/60 + lat[2]/3600;
const lonN = lon[0] + lon[1]/60 + lon[2]/3600;
await _db.from('footprints').insert([{ lat: latN, lng: lonN, img_url: miniData, user_id: myID }]);
}
if(file === files[files.length-1]) location.reload();
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
}
};

async function clearAll() {
if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', myID);
location.reload();
}
}

// å¯åŠ¨
window.onload = init;
</script>
</body>
</html>
