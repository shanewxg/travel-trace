<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>我的彩虹岁月地图</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<style>
body, html, #map { margin:0; height:100%; background: #000b1a; }
.ui-panel { position:fixed; z-index:9999; bottom:30px; left:50%; transform:translateX(-50%); width: 95%; text-align:center; display: flex; justify-content: center; gap: 10px; }
button {
padding: 12px 20px; color: white; border: none; border-radius: 25px;
font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 14px;
}
.btn-upload { background: linear-gradient(135deg, #667eea, #764ba2); }
.btn-clear { background: linear-gradient(135deg, #ff4b2b, #ff416c); }
.photo-marker { border: 2px solid white; border-radius: 50%; width:50px; height:50px; object-fit:cover; box-shadow: 0 0 10px rgba(255,255,255,0.8); transition: all 0.5s; }
</style>
</head>
<body>

<div id="map"></div>

<div class="ui-panel">
<button class="btn-upload" onclick="document.getElementById('fileIn').click()">开启彩虹记忆</button>
<button class="btn-clear" onclick="clearAll()">重启人生版图</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
// --- 1. 配置区 ---
const SUPABASE_URL = '你的URL';
const SUPABASE_KEY = '你的KEY';
const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const yearColors = {
"2023": "#ff4e50", "2024": "#f9d423", "2025": "#00f2fe", "2026": "#a8ff78", "default": "#ffffff"
};

// --- 2. 初始化地图 ---
var map = L.map('map', { zoomControl: false }).setView([34, 108], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- 3. 核心：动画播放历史轨迹 ---
async function loadHistory() {
const { data, error } = await _db.from('footprints').select('*').order('created_at', { ascending: true });

if (data && data.length > 0) {
let lastPoint = null;
let i = 0;

// 自动缩放以包含所有点
map.fitBounds(data.map(p => [p.lat, p.lng]), {padding: [50, 50]});

function drawNext() {
if (i >= data.length) return;

const p = data[i];
const year = new Date(p.created_at).getFullYear().toString();
const color = yearColors[year] || yearColors["default"];
const currentPoint = [p.lat, p.lng];

// 落下发光圆点
L.circleMarker(currentPoint, { radius: 6, color: color, fillColor: color, fillOpacity: 0.9 }).addTo(map);

// 如果有上一个点，拉出流光线
if (lastPoint) {
L.polyline.antPath([lastPoint, currentPoint], {
delay: 2000,
color: color,
pulseColor: "#ffffff",
weight: 4,
paused: false,
reverse: false
}).addTo(map);
}

lastPoint = currentPoint;
i++;
// 每一段轨迹生长间隔 800 毫秒，更有节奏感
setTimeout(drawNext, 800);
}

drawNext();
}
}
loadHistory();

// --- 4. 静默上传与实时预览 ---
document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
files.forEach(file => {
EXIF.getData(file, async function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");

if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

// 默默上传，不再弹出 alert
const { error } = await _db.from('footprints').insert([{
lat: latNum, lng: lonNum, img_url: "", user_id: "me"
}]);

if (!error) {
// 实时在地图上长出一个小头像
var tempUrl = URL.createObjectURL(file);
var icon = L.divIcon({
html: `<img src="${tempUrl}" class="photo-marker">`,
className: '', iconSize: [50, 50]
});
L.marker([latNum, lonNum], { icon: icon }).addTo(map);
// console.log 只是在后台记录，不会打扰你
console.log("足迹已同步");
}
}
});
});
};

// --- 5. 清空逻辑 ---
async function clearAll() {
if(confirm("确定要清空所有彩虹轨迹吗？")) {
const { error } = await _db.from('footprints').delete().neq('id', 0);
if(!error) location.reload();
}
}
</script>
</body>
</html>
