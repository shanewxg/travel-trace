<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æ—¶å…‰å›æº¯Â·ç»ˆæç¨³å¥ç‰ˆ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body, html, #map { margin: 0; height: 100%; background: #000b1a; }
.ui-panel { position: fixed; z-index: 1000; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; }
button { padding: 15px 25px; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
.btn-up { background: #ff416c; }
.btn-reset { background: rgba(255,255,255,0.2); }
.photo-polaroid {
border: 4px solid #fff; border-bottom: 12px solid #fff;
width: 80px; height: 80px; object-fit: cover;
box-shadow: 0 0 15px rgba(255,255,255,0.4);
animation: pop 0.5s ease-out;
}
@keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button class="btn-up" onclick="document.getElementById('fileIn').click()">ğŸ“· è®°å½•ç¬é—´</button>
<button class="btn-reset" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<script>
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SB_URL, SB_KEY);

// 1. ä¼˜å…ˆåˆå§‹åŒ–åœ°å›¾ï¼Œé˜²æ­¢é»‘å±
var map = L.map('map', { zoomControl: false }).setView([20, 0], 3);
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

// 2. åŠ ç²—è½¨è¿¹å‡½æ•°
async function drawLine(start, end) {
return new Promise(res => {
const line = L.polyline.antPath([start, start], {
color: '#00f2fe', pulseColor: '#ffffff', weight: 12, delay: 1000
}).addTo(map);

let i = 0;
const timer = setInterval(() => {
i++;
let lat = start[0] + (end[0]-start[0])*(i/40);
let lng = start[1] + (end[1]-start[1])*(i/40);
line.setLatLngs([start, [lat, lng]]);
if(i >= 40) { clearInterval(timer); res(); }
}, 25);
});
}

// 3. æ•°æ®åŠ è½½ï¼ˆå¸¦å®¹é”™ï¼‰
async function loadData() {
try {
const { data, error } = await _db.from('footprints').select('*').order('created_at', {ascending: true});
if(error || !data || data.length === 0) return;

map.flyTo([data[0].lat, data[0].lng], 7);
await new Promise(r => setTimeout(r, 3000));

let last = null;
for(let item of data) {
const pos = [item.lat, item.lng];
if(last) await drawLine(last, pos);

const icon = L.divIcon({
className: '',
html: item.img_url ? `<img src="${item.img_url}" class="photo-polaroid">` : `<div style="background:#00f2fe;width:10px;height:10px;border-radius:50%"></div>`,
iconSize: [80, 95]
});
L.marker(pos, {icon: icon}).addTo(map);
map.panTo(pos);
await new Promise(r => setTimeout(r, 1000));
last = pos;
}
} catch(e) { console.log("æ•°æ®åŠ è½½ç•¥æœ‰æ³¢æŠ˜ï¼Œä½†ä¸å½±å“åœ°å›¾ã€‚"); }
}

// ç¡®ä¿åº“åŠ è½½åå†è¿è¡Œ
setTimeout(loadData, 1000);

// 4. å¼ºåˆ¶å‹ç¼©ä¸Šä¼ 
document.getElementById('fileIn').onchange = function(e) {
const file = e.target.files[0];
if(!file) return;

const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = function() {
const canvas = document.createElement('canvas');
// ç‹ ç‹ å‹ç¼©åˆ° 200 åƒç´ ï¼Œç¡®ä¿ä¸é»‘å±
canvas.width = 200; canvas.height = 200;
canvas.getContext('2d').drawImage(img, 0, 0, 200, 200);
const miniBase64 = canvas.toDataURL('image/jpeg', 0.5);

EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude");
const lon = EXIF.getTag(this, "GPSLongitude");
if(lat && lon) {
const latNum = (lat[0] + lat[1]/60 + lat[2]/3600);
const lonNum = (lon[0] + lon[1]/60 + lon[2]/3600);
await _db.from('footprints').insert([{ lat: latNum, lng: lonNum, img_url: miniBase64, user_id: 'me' }]);
location.reload();
} else { alert("ç…§ç‰‡æ²¡åæ ‡ä¿¡æ¯"); }
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
};

async function clearAll() {
if(confirm("é‡ç½®å—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', 'me');
location.reload();
}
}
</script>
</body>
</html>
