<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>我的旅行足迹 - 音乐流光版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<style>
body { margin:0; padding:0; background: #001529; }
#map { height:100vh; width:100%; }
.btn-box { position:fixed; z-index:9999; bottom:50px; left:50%; transform:translateX(-50%); }
button {
padding: 18px 45px; background: linear-gradient(135deg, #1890ff, #722ed1);
color: white; border: none; border-radius: 50px; font-size: 18px; font-weight: bold;
cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.photo-marker {
border: 3px solid #fff; border-radius: 12px; box-shadow: 0 0 20px rgba(24, 144, 255, 0.6);
width:80px; height:80px; object-fit:cover; animation: starPulse 2s infinite ease-in-out;
}
@keyframes starPulse {
0%, 100% { transform: scale(1); filter: brightness(1); }
50% { transform: scale(1.08); filter: brightness(1.2); }
}
.custom-runner {
width: 18px; height: 18px; background: #fff;
border: 4px solid #1890ff; border-radius: 50%; box-shadow: 0 0 20px #1890ff;
}
</style>
</head>
<body>

<div id="map"></div>
<audio id="bgMusic" loop>
<source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<div class="btn-box" id="controlPanel">
<button onclick="handleStart()">上传照片 & 开启奇迹</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
var map = L.map('map', { zoomControl: false }).setView([25, 30], 2.5);
L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
subdomains: ["1", "2", "3", "4"]
}).addTo(map);

function handleStart() {
// 尝试播放音乐
const music = document.getElementById('bgMusic');
music.play().catch(e => console.log("等待交互播放"));
// 触发上传
document.getElementById('fileIn').click();
}

document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
var photoData = [];
var loaded = 0;
document.getElementById('controlPanel').style.display = 'none';

files.forEach(function(file) {
EXIF.getData(file, function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
var timeStr = EXIF.getTag(this, "DateTime");
if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);
photoData.push({ lat: latNum, lng: lonNum, url: URL.createObjectURL(file),
time: timeStr ? new Date(timeStr.replace(/:/g, '-').replace(' ', 'T')) : new Date() });
}
loaded++;
if (loaded === files.length) {
photoData.sort((a, b) => a.time - b.time);
if(photoData.length > 0) startFlow(photoData);
}
});
});
};

async function startFlow(data) {
await new Promise(r => setTimeout(r, 1500));
var bounds = data.map(p => [p.lat, p.lng]);
await new Promise(r => {
map.once('moveend', r);
map.fitBounds(bounds, { padding: [100, 100], duration: 1.5 });
});
await new Promise(r => setTimeout(r, 800));
await new Promise(r => {
map.once('moveend', r);
map.flyTo([data[0].lat, data[0].lng], 14, { duration: 2.5 });
});
runJourney(data);
}

async function runJourney(data) {
var routePoints = [];
var runnerIcon = L.divIcon({ html: `<div class="custom-runner"></div>`, className: '', iconSize: [18, 18], iconAnchor: [9, 9] });
var runner = L.marker([data[0].lat, data[0].lng], { icon: runnerIcon }).addTo(map);

for (let i = 0; i < data.length; i++) {
let p = data[i];
let currentPos = [p.lat, p.lng];
routePoints.push(currentPos);
if (i > 0) {
let prevPos = routePoints[i-1];
await new Promise(resolve => {
let startTime = null;
function animate(currentTime) {
if (!startTime) startTime = currentTime;
let t = Math.min((currentTime - startTime) / 1200, 1);
let easeT = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
let pos = [prevPos[0] + (currentPos[0] - prevPos[0]) * easeT, prevPos[1] + (currentPos[1] - prevPos[1]) * easeT];
runner.setLatLng(pos);
map.panTo(pos, { animate: false });
L.polyline([prevPos, pos], { color: `hsl(${200 + (i/data.length)*60},100%,60%)`, weight: 6 }).addTo(map);
if (t < 1) requestAnimationFrame(animate); else resolve();
}
requestAnimationFrame(animate);
});
}
let icon = L.divIcon({ html: `<img src="${p.url}" class="photo-marker">`, className: '', iconSize: [80, 80], iconAnchor: [40, 40] });
L.marker(currentPos, { icon: icon }).addTo(map);
await new Promise(r => setTimeout(r, 800));
}
map.flyToBounds(routePoints, { padding: [120, 120], duration: 2.5 });
}
</script>
</body>
</html>
