<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·é«˜å…‰æ—¶åˆ»</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<style>
body, html, #map { margin:0; height:100%; background: #000b1a; }
.ui-panel { position:fixed; z-index:9999; bottom:30px; left:50%; transform:translateX(-50%); width: 95%; text-align:center; display: flex; justify-content: center; gap: 15px; }
button { padding: 14px 25px; color: white; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.4); font-size: 14px; }
.btn-upload { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
.btn-clear { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); color: #ccc; }

/* æ‹ç«‹å¾—ç…§ç‰‡æ ·å¼ */
.photo-frame {
border: 4px solid white;
border-bottom: 12px solid white;
border-radius: 4px;
width: 80px;
height: 80px;
object-fit: cover;
box-shadow: 0 10px 25px rgba(0,0,0,0.5);
animation: popIn 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
@keyframes popIn { 0% { transform: scale(0) rotate(-15deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
</style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
<button class="btn-upload" onclick="document.getElementById('fileIn').click()">ğŸ“· è®°å½•ç¬é—´</button>
<button class="btn-clear" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
const SUPABASE_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const yearColors = {
"2018": "#FFB6C1", "2019": "#1E90FF", "2020": "#800080", "2021": "#90EE90", "2022": "#00FF00",
"2023": "#FFFF00", "2024": "#FFA500", "2025": "#FF4500", "2026": "#FF0000", "default": "#FFFFFF"
};

var map = L.map('map', { zoomControl: false, scrollWheelZoom: true }).setView([20, 0], 3);
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

// --- é†’ç›®çš„éœ“è™¹è½¨è¿¹ç»˜åˆ¶ ---
async function drawNeonPath(start, end, color) {
return new Promise((resolve) => {
const steps = 40;
let current = 0;
// å¢åŠ çº¿æ¡ç²—åº¦ (weight: 8) å’Œå…‰æ™•æ„Ÿ (pulseColor)
const path = L.polyline.antPath([start, start], {
delay: 1500, color: color, pulseColor: "#ffffff", weight: 8, dashArray: [10, 20]
}).addTo(map);

const timer = setInterval(() => {
current++;
const lat = start[0] + (end[0] - start[0]) * (current / steps);
const lng = start[1] + (end[1] - start[1]) * (current / steps);
path.setLatLngs([start, [lat, lng]]);
if (current >= steps) { clearInterval(timer); resolve(); }
}, 30);
});
}

async function loadHistory() {
try {
const { data } = await _db.from('footprints').select('*').order('created_at', { ascending: true });
if (!data || data.length === 0) return;

map.flyTo([data[0].lat, data[0].lng], 8, { duration: 3 });
await new Promise(r => setTimeout(r, 3500));

let lastPos = null;
for (let item of data) {
const year = new Date(item.created_at).getFullYear();
const color = yearColors[year] || yearColors["default"];
const pos = [item.lat, item.lng];

if (lastPos) await drawNeonPath(lastPos, pos, color);

// è½¨è¿¹åˆ°è¾¾ï¼šå±•ç¤ºç…§ç‰‡
map.panTo(pos, { animate: true });
const iconHtml = item.img_url
? `<img src="${item.img_url}" class="photo-frame">`
: `<div class="photo-frame" style="background:${color}; display:flex; align-items:center; justify-content:center; color:white;">${year}</div>`;

L.marker(pos, { icon: L.divIcon({ html: iconHtml, className: '', iconSize: [80, 80] }) }).addTo(map);

await new Promise(r => setTimeout(r, 1500));
lastPos = pos;
}
} catch (e) { console.error(e); }
}
loadHistory();

// --- å›¾ç‰‡å‹ç¼©å¹¶è½¬å­˜é€»è¾‘ ---
document.getElementById('fileIn').onchange = function(e) {
const files = Array.from(e.target.files);
files.forEach(file => {
const reader = new FileReader();
reader.onload = function(event) {
const img = new Image();
img.onload = function() {
// å‹ç¼©å›¾ç‰‡é˜²æ­¢æ•°æ®åº“å¡æ»¡
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
canvas.width = 300; canvas.height = 300;
ctx.drawImage(img, 0, 0, 300, 300);
const base64 = canvas.toDataURL('image/jpeg', 0.7);

EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
const latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
const latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
const lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);

// å…³é”®ï¼šæŠŠ base64 å›¾ç‰‡å­˜å…¥ img_url
await _db.from('footprints').insert([{ lat: latNum, lng: lonNum, img_url: base64, user_id: "me" }]);
location.reload();
}
});
};
img.src = event.target.result;
};
reader.readAsDataURL(file);
});
};

async function clearAll() {
if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', 'me');
window.location.reload();
}
}
</script>
</body>
</html>
