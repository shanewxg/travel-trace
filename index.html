<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·å…¨ç«¯å…¼å®¹ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body, html, #map { margin:0; height:100%; width:100%; background: #000b1a; overflow: hidden; }
.ui-panel { position:fixed; z-index:9999; bottom:20px; left:50%; transform:translateX(-50%); display: flex; gap: 8px; width: 95%; justify-content: center; }
button {
padding: 10px 14px; color: white; border: none; border-radius: 20px;
font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2);
font-size: 12px; white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.btn-clear { background: rgba(255,255,255,0.1) !important; color: #ccc !important; }
.photo-marker-icon { border: 2px solid white; border-radius: 8px; width:90px; height:90px; object-fit:cover; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.top-ui { position: fixed; top: 15px; left: 15px; z-index: 10000; display: flex; gap: 10px; }
.status-tag { padding: 5px 12px; background: rgba(0,0,0,0.5); border-radius: 15px; color: white; font-size: 12px; backdrop-filter: blur(5px); }
.share-modal { display: none; position: fixed; z-index: 20000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; }
.share-box { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; }
#shareImg { width: 100%; border-radius: 10px; margin: 15px 0; }
</style>
</head>
<body>

<div class="top-ui">
<div class="status-tag" id="musicBtn">ğŸ¶ <span id="mTxt">æ’­æ”¾éŸ³ä¹</span></div>
<div class="status-tag" id="loadStatus" style="display:none;">ğŸš€ æ­£åœ¨åŒæ­¥...</div>
</div>
<audio id="bgm" loop></audio> <div id="map"></div>

<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· å½©è™¹å…‰å½±</button>
<button onclick="openShare()">ğŸ”— åˆ†äº«è¶³è¿¹</button>
<button class="btn-clear" onclick="clearAll()">ğŸ•¯ï¸ é‡å¯</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<div id="shareModal" class="share-modal">
<div class="share-box">
<h3 style="margin:0; color: #333;">è¶³è¿¹å¿«ç…§</h3>
<img id="shareImg">
<button id="dlBtn" style="width:100%; padding: 12px; background: #667eea; color:white; border:none; border-radius:10px;">ä¿å­˜å›¾ç‰‡</button>
<p style="color:#999; font-size:12px; margin-top:15px;" onclick="closeShare()">ç‚¹å‡»æ­¤å¤„å…³é—­</p>
</div>
</div>

<script>
// ======= ğŸš© å¡«å…¥ä¿¡æ¯ï¼ˆç¡®ä¿ URL ä»¥ https:// å¼€å¤´ï¼‰ =======
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const BGM_URL = 'ä½ çš„éŸ³ä¹é“¾æ¥.mp3';

// å»ºç«‹ ID æœºåˆ¶
function getMyID() {
let id = localStorage.getItem('my_footprint_id');
if (!id) {
id = 'user_' + Math.random().toString(36).substr(2, 9);
localStorage.setItem('my_footprint_id', id);
}
return id;
}
const myID = getMyID();
const yearColors = { "2024": "#FF4500", "2025": "#FFD700", "default": "#00BFFF" };

let _db;
let map;

// åˆå§‹åŒ–ä¸€åˆ‡
function initAll() {
try {
// 1. åˆå§‹åŒ–æ•°æ®åº“
_db = supabase.createClient(SB_URL, SB_KEY);

// 2. åˆå§‹åŒ–åœ°å›¾
map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([30, 110], 4);

// ä½¿ç”¨æ›´å…¼å®¹çš„åº•å›¾ URL (å¼ºåˆ¶ https)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
crossOrigin: true
}).addTo(map);

// 3. éŸ³ä¹è®¾ç½®
const bgm = document.getElementById('bgm');
bgm.src = BGM_URL;

// 4. å¼€å§‹åŠ è½½æ•°æ®
loadHistory();
} catch (e) {
console.error("åˆå§‹åŒ–å¤±è´¥:", e);
alert("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®");
}
}

function dropPhoto(point, color, imgUrl) {
L.circleMarker(point, { radius: 5, color: color, fillColor: "#fff", fillOpacity: 1 }).addTo(map);
if (imgUrl) {
const icon = L.divIcon({
html: `<img src="${imgUrl}" class="photo-marker-icon">`,
iconSize: [90, 90], iconAnchor: [45, 90]
});
L.marker(point, {icon: icon}).addTo(map);
}
}

async function loadHistory() {
const status = document.getElementById('loadStatus');
status.style.display = 'block';

try {
const { data, error } = await _db.from('footprints')
.select('*')
.eq('user_id', myID)
.order('created_at', { ascending: true });

status.style.display = 'none';
if (error) throw error;
if (!data || data.length === 0) return;

let lastPoint = null;
for (let i = 0; i < data.length; i++) {
const p = data[i];
const currentPoint = [p.lat, p.lng];
const color = yearColors[new Date(p.created_at).getFullYear()] || yearColors.default;

map.flyTo(currentPoint, 11, { animate: true, duration: 1.0 });
await new Promise(r => setTimeout(r, 600));
dropPhoto(currentPoint, color, p.img_url);

if (lastPoint) {
L.polyline.antPath([lastPoint, currentPoint], {
delay: 600, weight: 7, color: color, pulseColor: '#FFFFFF', opacity: 0.8
}).addTo(map);
}
lastPoint = currentPoint;
await new Promise(r => setTimeout(r, 800));
}
map.flyToBounds(data.map(p => [p.lat, p.lng]), { padding: [40, 40] });
} catch (err) {
console.error("åŠ è½½æ•°æ®å¤±è´¥:", err);
status.innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•";
}
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰å¯åŠ¨
window.onload = initAll;

const mBtn = document.getElementById('musicBtn');
mBtn.onclick = () => {
const bgm = document.getElementById('bgm');
if (bgm.paused) { bgm.play(); document.getElementById('mTxt').innerText = "æš‚åœ"; }
else { bgm.pause(); document.getElementById('mTxt').innerText = "æ’­æ”¾"; }
};

document.getElementById('fileIn').onchange = async function(e) {
const files = Array.from(e.target.files);
for (const file of files) {
await new Promise(resolve => {
const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = async function() {
const canvas = document.createElement('canvas');
const size = 400;
canvas.width = size; canvas.height = size;
canvas.getContext('2d').drawImage(img, 0, 0, size, size);
const miniData = canvas.toDataURL('image/jpeg', 0.6);
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
const latR = EXIF.getTag(this, "GPSLatitudeRef"), lonR = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
const latN = (lat[0] + lat[1]/60 + lat[2]/3600) * (latR === "S" ? -1 : 1);
const lonN = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonR === "W" ? -1 : 1);
await _db.from('footprints').insert([{
lat: latN, lng: lonN, img_url: miniData, user_id: myID
}]);
}
resolve();
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
});
}
location.reload();
};

async function clearAll() {
if(confirm("ç¡®å®šè¦é‡å¯ã€ä½ è‡ªå·±çš„ã€‘æ±Ÿæ¹–å—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', myID);
location.reload();
}
}

async function openShare() {
const modal = document.getElementById('shareModal');
modal.style.display = 'flex';
const imgTag = document.getElementById('shareImg');
imgTag.style.display = 'none';
setTimeout(() => {
html2canvas(document.body, { useCORS: true }).then(canvas => {
const url = canvas.toDataURL('image/png');
imgTag.src = url;
imgTag.style.display = 'block';
document.getElementById('dlBtn').onclick = () => {
const a = document.createElement('a');
a.href = url; a.download = 'å½©è™¹è¶³è¿¹.png'; a.click();
};
});
}, 600);
}
function closeShare() { document.getElementById('shareModal').style.display = 'none'; }
</script>
</body>
</html>
