<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·æé€Ÿç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet"/>
<script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<style>
body, html, #map { margin:0; height:100%; width:100%; background: #000b1a; }
.ui-panel { position:fixed; z-index:9999; bottom:20px; left:50%; transform:translateX(-50%); display: flex; gap: 8px; }
button { padding: 10px 16px; color: white; border: none; border-radius: 20px; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); font-size: 13px; }
.photo-marker-icon { border: 2px solid white; border-radius: 8px; width:90px; height:90px; object-fit:cover; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
/* å¢åŠ ä¸€ä¸ªåŠ è½½æç¤ºï¼Œè®©ç”¨æˆ·çŸ¥é“å·²ç»åœ¨è¡ŒåŠ¨äº† */
#loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); color: white; z-index: 10001; font-family: sans-serif; display: none; }
</style>
</head>
<body>

<div id="loader">ğŸš€ æ­£åœ¨ç©¿è¶Šæ—¶å…‰...</div>
<div id="map"></div>

<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· å½©è™¹å…‰å½±</button>
<button onclick="location.reload()">ğŸ”„ é‡æ¼”è½¨è¿¹</button>
<button style="background:#444" onclick="clearAll()">ğŸ•¯ï¸ é‡å¯</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SB_URL, SB_KEY);

const yearColors = { "2024": "#FF4500", "2025": "#FFD700", "default": "#00BFFF" };

// 1. ç«‹å³åˆå§‹åŒ–åœ°å›¾ï¼Œä¸ç­‰å¾…
var map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([30, 110], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function dropPhoto(point, color, imgUrl) {
L.circleMarker(point, { radius: 5, color: color, fillColor: "#fff", fillOpacity: 1 }).addTo(map);
if (imgUrl) {
const icon = L.divIcon({
html: `<img src="${imgUrl}" class="photo-marker-icon">`,
iconSize: [90, 90], iconAnchor: [45, 90]
});
L.marker(point, {icon: icon}).addTo(map);
}
}

// --- âš¡ï¸ æé€ŸåŠ è½½é€»è¾‘ ---
async function startShow() {
// ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
const loader = document.getElementById('loader');
loader.style.display = 'block';

// åªè¦æŸ¥è¯¢ä¸€å¼€å§‹ï¼Œä¸å†ç­‰å…¨éƒ¨ç»“æœï¼Œç›´æ¥è·å–å¿«ç…§
const { data, error } = await _db.from('footprints').select('*').order('created_at', { ascending: true });

if (error || !data || data.length === 0) {
loader.style.display = 'none';
return;
}

loader.style.display = 'none';
let lastPoint = null;

// æ ¸å¿ƒä¼˜åŒ–ï¼šå¹¶è¡Œæ¸²æŸ“
for (let i = 0; i < data.length; i++) {
const p = data[i];
const currentPoint = [p.lat, p.lng];
const color = yearColors[new Date(p.created_at).getFullYear()] || yearColors.default;

// é•œå¤´æ»‘è¡Œå’Œç…§ç‰‡è½åœ°å‡ ä¹åŒæ­¥ï¼Œä¸å†æ­»ç­‰
map.flyTo(currentPoint, 11, { animate: true, duration: 1.0 });

// ç¨å¾®é”™å¼€ 300ms è¥é€ è½åœ°æ„Ÿï¼Œè€Œä¸æ˜¯ç­‰ 2 ç§’
await new Promise(r => setTimeout(r, 400));
dropPhoto(currentPoint, color, p.img_url);

if (lastPoint) {
L.polyline.antPath([lastPoint, currentPoint], {
delay: 600, weight: 7, color: color, pulseColor: '#FFFFFF', opacity: 0.8
}).addTo(map);
}

lastPoint = currentPoint;
// æ¯ç«™åœç•™æçŸ­æ—¶é—´ï¼Œä¿æŒæµç•…
await new Promise(r => setTimeout(r, 600));
}

// æœ€ç»ˆå…¨å±€é¢„è§ˆ
map.flyToBounds(data.map(p => [p.lat, p.lng]), { padding: [40, 40], duration: 1.5 });
}

// é¡µé¢åŠ è½½å®Œç«‹å³å¼€è·‘
window.addEventListener('load', startShow);

// ä¸Šä¼ å‹ç¼©ä¼˜åŒ–ï¼šå®‰å“é»‘å±æ€æ‰‹
document.getElementById('fileIn').onchange = async function(e) {
const files = Array.from(e.target.files);
for (const file of files) {
await new Promise(resolve => {
const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = async function() {
const canvas = document.createElement('canvas');
// å‹ç¼©åˆ° 400 åƒç´ ï¼Œå®‰å“åŠ è½½é€Ÿåº¦æå‡ 2 å€
const size = 400;
canvas.width = size; canvas.height = size;
canvas.getContext('2d').drawImage(img, 0, 0, size, size);
const miniData = canvas.toDataURL('image/jpeg', 0.6);
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
const latR = EXIF.getTag(this, "GPSLatitudeRef"), lonR = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
const latN = (lat[0] + lat[1]/60 + lat[2]/3600) * (latR === "S" ? -1 : 1);
const lonN = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonR === "W" ? -1 : 1);
await _db.from('footprints').insert([{ lat: latN, lng: lonN, img_url: miniData, user_id: "me" }]);
}
resolve();
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
});
}
location.reload();
};

async function clearAll() {
if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
await _db.from('footprints').delete().neq('id', 0);
location.reload();
}
}
</script>
</body>
</html>
