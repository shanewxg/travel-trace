<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆæ”¾æ˜ æœº</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<style>
body, html, #map { margin:0; height:100%; background: #000b1a; font-family: "Microsoft YaHei", sans-serif; }
.ui-panel { position:fixed; z-index:9999; bottom:30px; left:50%; transform:translateX(-50%); width: 95%; text-align:center; display: flex; justify-content: center; gap: 10px; }
button {
padding: 12px 20px; color: white; border: none; border-radius: 25px;
font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 14px;
transition: all 0.3s;
}
button:active { transform: scale(0.9); }
.btn-upload { background: linear-gradient(135deg, #667eea, #764ba2); }
.btn-clear { background: linear-gradient(135deg, #ff4b2b, #ff416c); }

/* éŸ³ä¹æŒ‰é’®æ ·å¼ */
.music-control { position: fixed; top: 20px; right: 20px; z-index: 10000; background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; backdrop-filter: blur(5px); }

.photo-marker { border: 2px solid white; border-radius: 50%; width:50px; height:50px; object-fit:cover; box-shadow: 0 0 15px rgba(255,255,255,0.8); animation: popIn 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
@keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div id="map"></div>

<div class="music-control" onclick="toggleMusic()" id="musicBtn">ğŸµ</div>
<audio id="bgm" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio> <div class="ui-panel">
<button class="btn-upload" onclick="document.getElementById('fileIn').click()">å¼€å¯å½©è™¹è®°å¿†</button>
<button class="btn-clear" onclick="clearAll()">é‡å¯äººç”Ÿç‰ˆå›¾</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
const SUPABASE_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- 1. ä¸¥æ ¼çš„å²æœˆè‰²å¡åˆ†é… ---
const yearColors = {
"2018": "#FFB6C1", // ç²‰è‰²
"2019": "#1E90FF", // è“è‰²
"2020": "#800080", // ç´«è‰²
"2021": "#90EE90", // æµ…ç»¿è‰²
"2022": "#008000", // ç»¿è‰²
"2023": "#556B2F", // æ£•ç»¿è‰²
"2024": "#8B4513", // æ£•è‰²
"2025": "#FFFF00", // é»„è‰²
"2026": "#FF8C00", // æ©™è‰²
"2027": "#FF0000", // çº¢è‰²
"default": "#FFFFFF"
};

let lastGlobalPoint = null;

// --- 2. åˆå§‹åŒ–åœ°å›¾ï¼ˆå¼€åœºé«˜ç©ºè§†è§’ï¼‰ ---
var map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- 3. ä¸æ»‘åŠ è½½ä¸ä¿¯å†²åŠ¨ç”» ---
async function loadHistory() {
const { data } = await _db.from('footprints').select('*').order('created_at', { ascending: true });

if (data && data.length > 0) {
// ç¬¬ä¸€æ­¥ï¼šå…ˆç¼“ç¼“ä¿¯å†²åˆ°è¶³è¿¹åŒºåŸŸ
map.flyTo([data[0].lat, data[0].lng], 5, { duration: 3 });

setTimeout(() => {
let i = 0;
function drawNext() {
if (i >= data.length) return;

const p = data[i];
const year = new Date(p.created_at).getFullYear().toString();
const color = yearColors[year] || yearColors["default"];
const currentPoint = [p.lat, p.lng];

// è½ä¸‹å‘å…‰ç‚¹
L.circleMarker(currentPoint, { radius: 7, color: color, fillColor: color, fillOpacity: 0.8 }).addTo(map);

if (lastGlobalPoint) {
// ä¸æ»‘ç”Ÿé•¿çš„çº¿æ¡
L.polyline.antPath([lastGlobalPoint, currentPoint], {
delay: 3000, // è°ƒæ…¢æµå…‰é€Ÿåº¦
color: color,
pulseColor: "#ffffff",
weight: 4
}).addTo(map);
}

lastGlobalPoint = currentPoint;
i++;
// æ¯ä¸€æ®µç”Ÿé•¿é—´éš”æ‹‰é•¿åˆ° 1.5 ç§’ï¼Œè®©çœ¼ç›è·Ÿå¾—ä¸Š
setTimeout(drawNext, 1500);
}
drawNext();
}, 3500); // ç­‰ä¿¯å†²åŠ¨ç”»åšå®Œå†å¼€å§‹ç”»çº¿
}
}
loadHistory();

// --- 4. éŸ³ä¹æ§åˆ¶ ---
function toggleMusic() {
const bgm = document.getElementById('bgm');
const btn = document.getElementById('musicBtn');
if (bgm.paused) {
bgm.play();
btn.style.animation = "spin 3s linear infinite";
btn.innerText = "ğŸ’¿";
} else {
bgm.pause();
btn.style.animation = "";
btn.innerText = "ğŸµ";
}
}

// --- 5. ä¸Šä¼ ä¸å®æ—¶è¿çº¿ ---
document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
files.forEach(file => {
EXIF.getData(file, async function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);
const currentPoint = [latNum, lonNum];

const { error } = await _db.from('footprints').insert([{ lat: latNum, lng: lonNum, img_url: "", user_id: "me" }]);
if (!error) {
var tempUrl = URL.createObjectURL(file);
var icon = L.divIcon({ html: `<img src="${tempUrl}" class="photo-marker">`, className: '', iconSize: [50, 50] });
L.marker(currentPoint, { icon: icon }).addTo(map);
if (lastGlobalPoint) {
const year = new Date().getFullYear().toString();
L.polyline.antPath([lastGlobalPoint, currentPoint], { delay: 3000, color: yearColors[year] || "#fff", weight: 4 }).addTo(map);
}
lastGlobalPoint = currentPoint;
map.panTo(currentPoint);
}
}
});
});
};

async function clearAll() {
if(confirm("ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
await _db.from('footprints').delete().neq('id', 0);
location.reload();
}
}
</script>

<style>
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</body>
</html>
