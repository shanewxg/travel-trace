<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>我的旅行足迹-星光流光版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<style>
body { margin:0; padding:0; background: #f0f2f5; font-family: sans-serif; }
#map { height:100vh; width:100%; background: #f0f2f5; }

.btn-box { position:fixed; z-index:9999; bottom:50px; left:50%; transform:translateX(-50%); }
button {
padding: 18px 45px; background: linear-gradient(135deg, #1890ff, #722ed1);
color: white; border: none; border-radius: 50px; font-size: 18px; font-weight: bold;
cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: 0.3s;
}
button:hover { transform: scale(1.05); filter: brightness(1.1); }

/* 照片标记：增加了你想要的“发光”感 */
.photo-marker {
border: 3px solid #fff; border-radius: 12px;
/* 蓝色和紫色的重叠阴影，营造发光氛围 */
box-shadow: 0 0 15px rgba(24, 144, 255, 0.5), 0 5px 15px rgba(0,0,0,0.2);
width:80px; height:80px; object-fit:cover;
animation: starPulse 2s infinite ease-in-out; /* 持续的呼吸感 */
}

@keyframes starPulse {
0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(24, 144, 255, 0.5); }
50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(114, 46, 209, 0.7); }
}

/* 跑步小球 */
.custom-runner {
width: 18px; height: 18px; background: #fff;
border: 4px solid #1890ff; border-radius: 50%; box-shadow: 0 0 20px #1890ff;
}
</style>
</head>
<body>

<div id="map"></div>
<div class="btn-box" id="controlPanel">
<button onclick="document.getElementById('fileIn').click()">上传照片，见证奇迹</button>
</div>
<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
// 1. 初始化上帝视角 (上帝看地球)
var map = L.map('map', { zoomControl: false, zoomSnap: 0.1 }).setView([25, 30], 2.5);

L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
subdomains: ["1", "2", "3", "4"],
keepBuffer: 10
}).addTo(map);

var runnerMarker = null;

document.getElementById('fileIn').onchange = function(e) {
var files = Array.from(e.target.files);
var photoData = [];
var loaded = 0;
document.getElementById('controlPanel').style.display = 'none';

files.forEach(function(file) {
EXIF.getData(file, function() {
var lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
var latRef = EXIF.getTag(this, "GPSLatitudeRef"), lonRef = EXIF.getTag(this, "GPSLongitudeRef");
var timeStr = EXIF.getTag(this, "DateTime");
if (lat && lon) {
var latNum = (lat[0] + lat[1]/60 + lat[2]/3600) * (latRef === "S" ? -1 : 1);
var lonNum = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonRef === "W" ? -1 : 1);
photoData.push({ lat: latNum, lng: lonNum, url: URL.createObjectURL(file),
time: timeStr ? new Date(timeStr.replace(/:/g, '-').replace(' ', 'T')) : new Date() });
}
loaded++;
if (loaded === files.length) {
photoData.sort((a, b) => a.time - b.time);
if(photoData.length > 0) startCinematicFlow(photoData);
}
});
});
};

async function startCinematicFlow(data) {
// 停留看一眼世界地图，同时后台预加载
await new Promise(r => setTimeout(r, 2000));

// 第一跳：先跳到照片大致区域（全景预热）
var bounds = data.map(p => [p.lat, p.lng]);
await new Promise(r => {
map.once('moveend', r);
map.fitBounds(bounds, { padding: [100, 100], duration: 1.5 });
});

await new Promise(r => setTimeout(r, 800));

// 第二跳：深度俯冲到第一个点
await new Promise(r => {
map.once('moveend', r);
map.flyTo([data[0].lat, data[0].lng], 14, { duration: 2.5, easeLinearity: 0.2 });
});

await runJourney(data);
}

async function runJourney(data) {
var routePoints = [];
var runnerIcon = L.divIcon({ html: `<div class="custom-runner"></div>`, className: '', iconSize: [18, 18], iconAnchor: [9, 9] });
runnerMarker = L.marker([data[0].lat, data[0].lng], { icon: runnerIcon, zIndexOffset: 1000 }).addTo(map);

for (let i = 0; i < data.length; i++) {
let p = data[i];
let currentPos = [p.lat, p.lng];
routePoints.push(currentPos);

if (i > 0) {
let prevPos = routePoints[i-1];
await new Promise(resolve => {
let startTime = null;
let duration = 1200;
function animate(currentTime) {
if (!startTime) startTime = currentTime;
let elapsed = currentTime - startTime;
let t = Math.min(elapsed / duration, 1);
let easeT = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
let pos = [prevPos[0] + (currentPos[0] - prevPos[0]) * easeT, prevPos[1] + (currentPos[1] - prevPos[1]) * easeT];
runnerMarker.setLatLng(pos);
map.panTo(pos, { animate: false });

// 渐变色轨迹
let hue = 200 + (i / data.length) * 60;
L.polyline([prevPos, pos], {
color: `hsl(${hue}, 100%, 60%)`,
weight: 6, opacity: 0.8, lineCap: 'round'
}).addTo(map);

if (t < 1) requestAnimationFrame(animate);
else resolve();
}
requestAnimationFrame(animate);
});
}

// 掉落发光的照片
let photoIcon = L.divIcon({
html: `<img src="${p.url}" class="photo-marker">`,
className: '', iconSize: [80, 80], iconAnchor: [40, 40]
});
L.marker(currentPos, { icon: photoIcon }).addTo(map);
await new Promise(r => setTimeout(r, 800));
}

// 结尾回拉
map.flyToBounds(routePoints, { padding: [120, 120], duration: 2.5 });
}
</script>
</body>
</html>
