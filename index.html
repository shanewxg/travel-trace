<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·èˆªæ‹çµé­‚ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.min.js"></script>

<style>
/* æ ¸å¿ƒï¼šé€šè¿‡å€¾æ–œå®¹å™¨æ¨¡æ‹Ÿâ€œä¿¯å†²â€è§†è§’ */
body, html { margin:0; height:100%; width:100%; background: #000b1a; overflow: hidden; }
#map {
height: 100%; width: 100%;
/* è¿™é‡Œçš„è§†è§’å€¾æ–œæ˜¯çµé­‚ */
transform: perspective(800px) rotateX(5deg);
transform-origin: bottom;
}

.ui-panel { position:fixed; z-index:9999; bottom:30px; left:50%; transform:translateX(-50%); display: flex; gap: 15px; }
button {
padding: 14px 25px; color: white; border: none; border-radius: 30px;
font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
background: linear-gradient(135deg, #667eea, #764ba2);
}
.btn-clear { background: rgba(255,255,255,0.1) !important; color: #ccc !important; }

/* ç…§ç‰‡æ ‡è®°ï¼šå¸¦å‘å…‰å’Œæµ®åŠ¨æ„Ÿ */
.photo-marker-icon {
border: 3px solid white; border-radius: 12px;
width:70px; height:70px; object-fit:cover;
box-shadow: 0 10px 25px rgba(0,0,0,0.5);
transition: transform 0.3s ease;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="ui-panel">
<button onclick="document.getElementById('fileIn').click()">ğŸ“· æ³¨å…¥è¶³è¿¹</button>
<button class="btn-clear" onclick="clearAll()">ğŸ•¯ï¸ é‡å¯æ±Ÿæ¹–</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script>
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const _db = supabase.createClient(SB_URL, SB_KEY);

const yearColors = { "2024": "#FF4500", "2025": "#FFD700", "default": "#00BFFF" };

// åˆå§‹åŒ–åœ°å›¾
var map = L.map('map', { zoomControl: false, scrollWheelZoom: true }).setView([30, 110], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// è½¨è¿¹å‡½æ•°ï¼šåŠ ç²—ä¸”å¸¦æµåŠ¨æ„Ÿ
function drawPath(start, end, color) {
return L.polyline.antPath([start, end], {
delay: 1000, dashArray: [10, 20], weight: 8, color: color, pulseColor: '#FFFFFF', opacity: 0.7
}).addTo(map);
}

// æ”¾ç½®ç…§ç‰‡
function dropPhoto(point, color, imgUrl) {
if (imgUrl) {
const icon = L.divIcon({
html: `<img src="${imgUrl}" class="photo-marker-icon">`,
iconSize: [70, 70], className: ''
});
return L.marker(point, {icon: icon}).addTo(map);
}
}

// --- æ ¸å¿ƒï¼šèˆªæ‹è·Ÿéšå‰§æœ¬ ---
async function loadHistory() {
const { data } = await _db.from('footprints').select('*').order('created_at', { ascending: true });
if (data && data.length > 0) {
let lastPoint = null;

for (let i = 0; i < data.length; i++) {
const p = data[i];
const currentPoint = [p.lat, p.lng];
const color = yearColors[new Date(p.created_at).getFullYear()] || yearColors.default;

// 1. é•œå¤´å¹³æ»‘â€œæ»‘ç¿”â€è¿‡å»ï¼Œä¸å¼ºè¡Œä¸­æ–­ç”¨æˆ·æ“ä½œ
map.flyTo(currentPoint, map.getZoom(), {
animate: true,
duration: 2,
easeLinearity: 0.25
});

// 2. ç­‰å¾…é•œå¤´æ»‘ç¿”åˆ°ä¸€åŠæ—¶ï¼Œç…§ç‰‡å…ˆè¡Œâ€œç€é™†â€
await new Promise(r => setTimeout(r, 1000));
dropPhoto(currentPoint, color, p.img_url);

// 3. è½¨è¿¹ç´§éšå…¶åâ€œé•¿â€å‡ºæ¥
if (lastPoint) {
drawPath(lastPoint, currentPoint, color);
}

lastPoint = currentPoint;
// æ¯ç«™åœç•™ä¸€ä¼šå„¿ï¼Œå±•ç¤ºç…§ç‰‡
await new Promise(r => setTimeout(r, 1200));
}
}
}
loadHistory();

// ä¸Šä¼ é€»è¾‘
document.getElementById('fileIn').onchange = async function(e) {
const files = Array.from(e.target.files);
for (const file of files) {
await new Promise(resolve => {
const reader = new FileReader();
reader.onload = function(ev) {
const img = new Image();
img.onload = async function() {
const canvas = document.createElement('canvas');
const size = 500;
canvas.width = size; canvas.height = size;
canvas.getContext('2d').drawImage(img, 0, 0, size, size);
const miniData = canvas.toDataURL('image/jpeg', 0.8);
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
const latR = EXIF.getTag(this, "GPSLatitudeRef"), lonR = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
const latN = (lat[0] + lat[1]/60 + lat[2]/3600) * (latR === "S" ? -1 : 1);
const lonN = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonR === "W" ? -1 : 1);
await _db.from('footprints').insert([{ lat: latN, lng: lonN, img_url: miniData, user_id: "me" }]);
}
resolve();
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
});
}
location.reload();
};

async function clearAll() {
if(confirm("ç¡®å®šè¦é‡å¯æ±Ÿæ¹–å—ï¼Ÿ")) {
await _db.from('footprints').delete().neq('id', 0);
location.reload();
}
}
</script>
</body>
</html>
