<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å½©è™¹å²æœˆÂ·è¶³è¿¹åˆ†äº«ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body, html, #map { margin:0; height:100%; width:100%; background: #000b1a; overflow: hidden; }
.ui-panel { position:fixed; z-index:9999; bottom:20px; left:50%; transform:translateX(-50%); display: flex; gap: 8px; width: 95%; justify-content: center; }
button { padding: 12px 18px; color: white; border: none; border-radius: 20px; font-weight: bold; background: linear-gradient(135deg, #667eea, #764ba2); font-size: 13px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
.photo-marker-icon { border: 2px solid white; border-radius: 8px; width:80px; height:80px; object-fit:cover; }
.top-ui { position: fixed; top: 15px; left: 15px; z-index: 10000; display: flex; gap: 10px; }
.status-tag { padding: 8px 15px; background: rgba(0,0,0,0.8); border-radius: 20px; color: white; font-size: 12px; border: 1px solid rgba(255,255,255,0.2); }
/* åˆ†äº«æˆåŠŸæç¤ºæ¡† */
#toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 25px; border-radius: 30px; display: none; z-index: 10001; }
</style>
</head>
<body>

<div class="top-ui">
<div class="status-tag" id="musicBtn" onclick="toggleMusic()">ğŸ¶ <span id="mTxt">å¼€å¯éŸ³ä¹</span></div>
<div class="status-tag" id="loadStatus">ğŸš¦ åˆå§‹åŒ–ä¸­...</div>
</div>
<div id="toast">âœ… ä¸“å±åˆ†äº«é“¾æ¥å·²å¤åˆ¶</div>

<audio id="bgm" loop preload="auto"></audio>
<div id="map"></div>

<div class="ui-panel">
<button id="recordBtn" onclick="document.getElementById('fileIn').click()">ğŸ“· è®°å½•è¶³è¿¹</button>
<button id="shareBtn" style="background: #ff9f43;" onclick="copyShareLink()">ğŸ”— åˆ†äº«è½¨è¿¹</button>
<button id="resetBtn" style="background:rgba(255,255,255,0.2)" onclick="clearAll()">ğŸ•¯ï¸ é‡ç½®</button>
</div>

<input type="file" id="fileIn" accept="image/*" multiple style="display:none">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
<script src="https://unpkg.com/exif-js@2.3.0/exif.js"></script>
<script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>

<script>
// ======= ğŸš© å¡«å…¥ä½ çš„é…ç½® =======
const SB_URL = 'https://pzgyvnpbnvxciruqflya.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6Z3l2bnBibnZ4Y2lydXFmbHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODAzNDAsImV4cCI6MjA4NzQ1NjM0MH0.WamSJoWx2-FSs-QfDZ4rZkhgLOqc-W4VpBmYphAkwsk';
const BGM_URL = 'https://cdn.pixabay.com/audio/2022/02/22/audio_d0c6ff1101.mp3';
// =============================

let _db, map;
// è¯†åˆ«èº«ä»½ï¼šæ˜¯ä¸»äººè¿˜æ˜¯é€šè¿‡åˆ†äº«é“¾æ¥ç‚¹è¿›æ¥çš„è®¿å®¢
const urlParams = new URLSearchParams(window.location.search);
const shareID = urlParams.get('id');
const isVisitor = !!shareID;

const myID = (() => {
if (isVisitor) return shareID; // å¦‚æœæœ‰IDåç¼€ï¼Œä½¿ç”¨åˆ†äº«çš„ID
let id = localStorage.getItem('my_footprint_id') || ('u_' + Math.random().toString(36).substr(2, 7));
localStorage.setItem('my_footprint_id', id);
return id;
})();

async function init() {
const status = document.getElementById('loadStatus');

// è®¿å®¢æ¨¡å¼UIè°ƒæ•´
if (isVisitor) {
document.getElementById('recordBtn').style.display = 'none';
document.getElementById('resetBtn').style.display = 'none';
document.getElementById('shareBtn').innerText = "æˆ‘ä¹Ÿè¦ç©";
document.getElementById('shareBtn').onclick = () => { location.href = location.pathname; };
}

try {
map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([34, 108], 4);
L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
subdomains: ["1", "2", "3", "4"],
crossOrigin: 'anonymous'
}).addTo(map);

_db = supabase.createClient(SB_URL, SB_KEY);
document.getElementById('bgm').src = BGM_URL;
await loadData();
} catch(e) { status.innerText = "âŒ å¯åŠ¨å¤±è´¥"; }
}

async function loadData() {
const status = document.getElementById('loadStatus');
status.innerText = isVisitor ? "ğŸ¿ æ­£åœ¨æŸ¥çœ‹åˆ†äº«è½¨è¿¹..." : "â³ åŒæ­¥ä¸­...";

const { data, error } = await _db.from('footprints').select('*').eq('user_id', myID).order('created_at', { ascending: true });

if (error) { status.innerText = "âŒ æ— æ³•è·å–æ•°æ®"; return; }
if (!data || data.length === 0) { status.innerText = "âœ¨ æš‚æ— è®°å½•"; return; }

status.innerText = "ğŸŒˆ ç»˜åˆ¶ä¸­...";
let points = [];
for (let p of data) {
const pos = [p.lat, p.lng];
points.push(pos);
map.flyTo(pos, 11, { animate: true, duration: 1.5 });
await new Promise(r => setTimeout(r, 1600));

L.circleMarker(pos, { radius: 6, color: "#fff", fillColor: "#00BFFF", fillOpacity: 1 }).addTo(map);
if (p.img_url) {
L.marker(pos, {
icon: L.divIcon({
html: `<img src="${p.img_url}" class="photo-marker-icon">`,
iconSize: [80, 80], iconAnchor: [40, 80]
})
}).addTo(map);
}
}
if (points.length > 1) L.polyline.antPath(points, { color: "#00BFFF" }).addTo(map);
status.style.display = 'none';
}

// åˆ†äº«åŠŸèƒ½æ ¸å¿ƒé€»è¾‘
function copyShareLink() {
const shareUrl = `${window.location.origin}${window.location.pathname}?id=${myID}`;

// å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
const el = document.createElement('textarea');
el.value = shareUrl;
document.body.appendChild(el);
el.select();
document.execCommand('copy');
document.body.removeChild(el);

// æ˜¾ç¤ºæç¤º
const toast = document.getElementById('toast');
toast.style.display = 'block';
setTimeout(() => { toast.style.display = 'none'; }, 2500);
}

// ... (ä»¥ä¸‹ processFile, toggleMusic, clearAll å‡½æ•°ä¿æŒä¸å˜) ...
document.getElementById('fileIn').onchange = async function(e) {
const files = Array.from(e.target.files);
const status = document.getElementById('loadStatus');
status.style.display = 'block';
for (let i = 0; i < files.length; i++) {
status.innerText = `ğŸ“¸ å¤„ç† ${i+1}/${files.length}`;
try { await processFile(files[i]); } catch (err) { alert(err); }
}
location.reload();
};

function processFile(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = (ev) => {
const img = new Image();
img.onload = () => {
const canvas = document.createElement('canvas');
canvas.width = 400; canvas.height = 400;
canvas.getContext('2d').drawImage(img, 0, 0, 400, 400);
const miniData = canvas.toDataURL('image/jpeg', 0.6);
EXIF.getData(file, async function() {
const lat = EXIF.getTag(this, "GPSLatitude");
const lon = EXIF.getTag(this, "GPSLongitude");
const latR = EXIF.getTag(this, "GPSLatitudeRef");
const lonR = EXIF.getTag(this, "GPSLongitudeRef");
if (lat && lon) {
const latN = (lat[0] + lat[1]/60 + lat[2]/3600) * (latR === "S" ? -1 : 1);
const lonN = (lon[0] + lon[1]/60 + lon[2]/3600) * (lonR === "W" ? -1 : 1);
await _db.from('footprints').insert([{ lat: latN, lng: lonN, img_url: miniData, user_id: myID }]);
resolve();
} else { reject("æ— GPSä¿¡æ¯"); }
});
};
img.src = ev.target.result;
};
reader.readAsDataURL(file);
});
}

function toggleMusic() {
const audio = document.getElementById('bgm');
const txt = document.getElementById('mTxt');
if (audio.paused) {
audio.play().then(() => { txt.innerText = "æ’­æ”¾ä¸­"; }).catch(() => alert("å…ˆç‚¹ä¸‹åœ°å›¾"));
} else {
audio.pause(); txt.innerText = "å·²æš‚åœ";
}
}

async function clearAll() {
if(confirm("é‡ç½®è¶³è¿¹å—ï¼Ÿ")) {
await _db.from('footprints').delete().eq('user_id', myID);
location.reload();
}
}

window.onload = init;
</script>
</body>
</html>
